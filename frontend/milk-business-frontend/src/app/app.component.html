<app-login *ngIf="!isLoggedIn"></app-login>

<div class="container" *ngIf="isLoggedIn">
  <header>
    <div class="header-content">
      <div class="logo-section">
        <h1>🥛 SHREE NIMISHAMBA ENTERPRISES</h1>
        <p>Milk Business Management System</p>
      </div>
      <div class="user-section">
        <button class="logout-btn" (click)="logout()">🚪 Logout</button>
      </div>
    </div>
  </header>

  <nav>
    <button (click)="activeTab = 'suppliers'" [class.active]="activeTab === 'suppliers'">🏪 Suppliers</button>
    <button (click)="activeTab = 'products'" [class.active]="activeTab === 'products'">📦 Products</button>
    <button (click)="activeTab = 'routes'" [class.active]="activeTab === 'routes'">🚛 Routes</button>
    <button (click)="activeTab = 'business-points'" [class.active]="activeTab === 'business-points'">🏢 Business Points</button>
    <button (click)="activeTab = 'production'" [class.active]="activeTab === 'production'">🏭 Production</button>
    <button (click)="activeTab = 'rates'" [class.active]="activeTab === 'rates'">💰 Rates</button>
    <button (click)="activeTab = 'sales'" [class.active]="activeTab === 'sales'">📊 Daily Sales</button>
    <button (click)="activeTab = 'bank-cashflow'" [class.active]="activeTab === 'bank-cashflow'">🏦 Bank Cash Flow</button>
    <button (click)="activeTab = 'reports'" [class.active]="activeTab === 'reports'">📈 Reports</button>
    <button (click)="activeTab = 'settings'" [class.active]="activeTab === 'settings'">⚙️ Settings</button>
    <button (click)="activeTab = 'agent-overview'" [class.active]="activeTab === 'agent-overview'">📅 Agent Overview</button>
    <button (click)="activeTab = 'route-dashboard'" [class.active]="activeTab === 'route-dashboard'">📊 Route Dashboard</button>
  </nav>

  <!-- Global Route Summary - Always Visible -->
  <div *ngIf="isLoggedIn" class="global-summary">
    <div class="summary-header">
      <h3>{{selectedGlobalRoute ? selectedGlobalRoute.name + ' Route Summary' : '🌍 All Routes Summary'}}</h3>
      <div class="route-selector">
        <button class="route-toggle" (click)="toggleRouteSelector()">
          {{selectedGlobalRoute ? selectedGlobalRoute.name : 'All Routes'}} ▼
        </button>
        <div *ngIf="showRouteDropdown" class="route-dropdown">
          <button (click)="selectGlobalRoute(null)" [class.active]="!selectedGlobalRoute">🌍 All Routes</button>
          <button *ngFor="let route of routes" 
                  (click)="selectGlobalRoute(route)" 
                  [class.active]="selectedGlobalRoute?.id === route.id">
            {{route.name}} Route
          </button>
        </div>
      </div>
    </div>
    <div class="global-summary-cards">
      <div class="global-card total">
        <label>Total Business</label>
        <span>₹{{getDisplayTotalBusiness()}}</span>
      </div>
      <div class="global-card debt">
        <label>Total Outstanding</label>
        <span>₹{{getDisplayTotalDebt()}}</span>
      </div>
      <div class="global-card received">
        <label>Today's Collection</label>
        <span>₹{{getDisplayTotalReceived()}}</span>
      </div>
      <div class="global-card balance">
        <label>Net Balance</label>
        <span>₹{{getDisplayNetBalance()}}</span>
      </div>
    </div>
  </div>

  <!-- Suppliers Tab -->
  <div *ngIf="activeTab === 'suppliers'" class="tab-content">
    <h2>Suppliers Management</h2>
    <form (ngSubmit)="saveSupplier()" #supplierForm="ngForm">
      <div class="form-row">
        <input type="text" [(ngModel)]="currentSupplier.name" name="name" placeholder="Supplier Name" required>
        <button type="submit">Add Supplier</button>
      </div>
    </form>
    
    <table>
      <thead>
        <tr>
          <th>Supplier Name</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let supplier of suppliers">
          <td>{{supplier.name}}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-update btn-sm" (click)="editSupplier(supplier)">✏️ Update</button>
              <button class="btn-delete btn-sm" (click)="deleteSupplier(supplier.id)">🗑️ Delete</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Products Tab -->
  <div *ngIf="activeTab === 'products'" class="tab-content">
    <h2>Products Management</h2>
    <form (ngSubmit)="saveProduct()" #productForm="ngForm">
      <div class="form-row">
        <select [(ngModel)]="currentProduct.supplier" name="supplier" required>
          <option value="">Select Supplier</option>
          <option *ngFor="let supplier of suppliers" [value]="supplier.id">{{supplier.name}}</option>
        </select>
        <input type="text" [(ngModel)]="currentProduct.name" name="name" placeholder="Product Name" required>
        <button type="submit">Add Product</button>
      </div>
    </form>
    
    <table>
      <thead>
        <tr>
          <th>Supplier</th>
          <th>Product Name</th>
          <th>Crate Multiplier</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let product of products">
          <td>{{product.supplier_name}}</td>
          <td>{{product.name}}</td>
          <td>{{product.crate_multiplier}}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-update btn-sm" (click)="editProduct(product)">✏️ Update</button>
              <button class="btn-delete btn-sm" (click)="deleteProduct(product.id)">🗑️ Delete</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Routes Tab -->
  <div *ngIf="activeTab === 'routes'" class="tab-content">
    <div class="section-header">
      <h2>Routes Management</h2>
      <div class="section-actions">
        <button class="print-btn" (click)="printRoutesList()">🖨️ Print</button>
        <button class="export-btn" (click)="exportRoutesData('csv')">📄 Export CSV</button>
        <button class="export-btn excel" (click)="exportRoutesData('excel')">📈 Export Excel</button>
      </div>
    </div>
    <form (ngSubmit)="saveRoute()" #routeForm="ngForm">
      <div class="form-row">
        <input type="text" [(ngModel)]="currentRoute.name" name="name" placeholder="Route Name (M3, M4...)" required>
        <button type="submit">Add Route</button>
      </div>
    </form>
    
    <table>
      <thead>
        <tr>
          <th>Route</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let route of routes">
          <td>{{route.name}}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-update btn-sm" (click)="editRoute(route)">✏️ Update</button>
              <button class="btn-delete btn-sm" (click)="deleteRoute(route.id)">🗑️ Delete</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Business Points Tab -->
  <div *ngIf="activeTab === 'business-points'" class="tab-content">
    <div class="section-header">
      <h2>Business Points Management (Agents)</h2>
      <div class="section-actions">
        <button class="print-btn" (click)="printBusinessPointsList()">🖨️ Print</button>
        <button class="export-btn" (click)="exportBusinessPointsData('csv')">📄 Export CSV</button>
        <button class="export-btn excel" (click)="exportBusinessPointsData('excel')">📈 Export Excel</button>
      </div>
    </div>
    <form (ngSubmit)="saveBusinessPoint()" #bpForm="ngForm">
      <div class="form-row">
        <select [(ngModel)]="currentBusinessPoint.route" name="route" required>
          <option value="">Select Route</option>
          <option *ngFor="let route of routes" [value]="route.id">{{route.name}}</option>
        </select>
        <input type="text" [(ngModel)]="currentBusinessPoint.name" name="name" placeholder="Agent Name (Shekara, Agent M4...)" required>
        <input type="email" [(ngModel)]="currentBusinessPoint.email" name="email" placeholder="Email Address" required>
        <input type="tel" [(ngModel)]="currentBusinessPoint.phone" name="phone" placeholder="Phone Number" required>
        <button type="submit">Add Agent</button>
      </div>
    </form>
    
    <table>
      <thead>
        <tr>
          <th>Route</th>
          <th>Agent Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let bp of businessPoints">
          <td>{{bp.route_name}}</td>
          <td>{{bp.name}}</td>
          <td>{{bp.email || 'Not set'}}</td>
          <td>{{bp.phone || 'Not set'}}</td>
          <td>
            <div class="action-buttons-horizontal">
              <button class="btn-update btn-sm" (click)="editBusinessPoint(bp)">✏️ Update</button>
              <button class="btn-delete btn-sm" (click)="deleteBusinessPoint(bp.id)">🗑️ Delete</button>
              <button class="btn-email btn-sm" (click)="sendEmail(bp)">📧 Email</button>
              <button class="btn-whatsapp btn-sm" (click)="sendWhatsApp(bp)">📱 WhatsApp</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Production Tab -->
  <div *ngIf="activeTab === 'production'" class="tab-content">
    <div class="section-header">
      <h2>Production Management</h2>
      <div class="section-actions">
        <button class="print-btn" (click)="printProductionList()">🖨️ Print</button>
        <button class="export-btn" (click)="exportProductionData('csv')">📄 Export CSV</button>
        <button class="export-btn excel" (click)="exportProductionData('excel')">📈 Export Excel</button>
      </div>
    </div>
    <form (ngSubmit)="saveProduction()" #productionForm="ngForm">
      <div class="form-row">
        <div class="form-field">
          <label>Route:</label>
          <select [(ngModel)]="currentProduction.route" name="route" required>
            <option value="">Select Route</option>
            <option *ngFor="let route of routes" [value]="route.id">{{route.name}}</option>
          </select>
        </div>
        <div class="form-field">
          <label>Supplier:</label>
          <select [(ngModel)]="currentProduction.supplier" name="supplier" required>
            <option value="">Select Supplier</option>
            <option *ngFor="let supplier of suppliers" [value]="supplier.id">{{supplier.name}}</option>
          </select>
        </div>
        <div class="form-field">
          <label>Product:</label>
          <select [(ngModel)]="currentProduction.product" name="product" required>
            <option value="">Select Product</option>
            <option *ngFor="let product of products" [value]="product.id">{{product.supplier_name}} - {{product.name}}</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>Date:</label>
          <input type="date" [(ngModel)]="currentProduction.date" name="date" required>
        </div>
        <div class="form-field">
          <label>Crates Produced:</label>
          <input type="number" [(ngModel)]="currentProduction.crates_produced" name="crates_produced" min="0" required>
        </div>
        <div class="form-field">
          <label>Crates Distributed:</label>
          <input type="number" [(ngModel)]="currentProduction.crates_distributed" name="crates_distributed" min="0" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field full-width">
          <label>Notes:</label>
          <textarea [(ngModel)]="currentProduction.notes" name="notes" placeholder="Additional notes..."></textarea>
        </div>
      </div>
      <div class="form-row">
        <button type="submit">{{currentProduction.id ? 'Update' : 'Add'}} Production</button>
      </div>
    </form>
    
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Route</th>
          <th>Supplier</th>
          <th>Product</th>
          <th>Produced</th>
          <th>Distributed</th>
          <th>Remaining</th>
          <th>Units (Produced/Distributed/Remaining)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let production of productions">
          <td>{{production.date}}</td>
          <td>{{production.route_name}}</td>
          <td>{{production.supplier_name}}</td>
          <td>{{production.product_name}}</td>
          <td>{{production.crates_produced}} crates</td>
          <td>{{production.crates_distributed}} crates</td>
          <td>{{production.crates_remaining}} crates</td>
          <td>{{production.total_units_produced}}/{{production.total_units_distributed}}/{{production.total_units_remaining}} units</td>
          <td>
            <div class="action-buttons-horizontal">
              <button class="btn-update btn-sm" (click)="editProduction(production)">✏️ Update</button>
              <button class="btn-delete btn-sm" (click)="deleteProduction(production.id)">🗑️ Delete</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Daily Sales Tab -->
  <div *ngIf="activeTab === 'sales'" class="tab-content">
    <h2>Daily Sales Entry</h2>
    
    <!-- Route Selection -->
    <div class="route-buttons">
      <h3>Select Route:</h3>
      <button *ngFor="let route of routes" 
              (click)="selectRoute(route)" 
              [class.active]="selectedRoute?.id === route.id">
        {{route.name}}
      </button>
    </div>

    <div *ngIf="selectedRoute" class="sales-section">
      <div class="section-header">
        <h3>{{selectedRoute.name}} Route Sales</h3>
        <div class="section-actions">
          <button class="print-btn" (click)="printSalesData()">🖨️ Print</button>
          <button class="export-btn" (click)="exportSalesData('csv')">📄 Export CSV</button>
          <button class="export-btn excel" (click)="exportSalesData('excel')">📈 Export Excel</button>
        </div>
      </div>
      
      <!-- Route Level Sales -->
      <div class="route-sales">
        <h4>Route Summary</h4>
        <form (ngSubmit)="saveRouteSales()" #routeSalesForm="ngForm">
          <div class="form-row">
            <div class="form-field">
              <label>Date:</label>
              <input type="date" [(ngModel)]="currentSales.date" name="date" required>
            </div>
            <div class="form-field">
              <label>Opening Balance:</label>
              <input type="number" [(ngModel)]="currentSales.opening_balance" name="opening_balance" step="0.01">
            </div>
            <div class="form-field">
              <label>Total Sales Amount:</label>
              <input type="number" [(ngModel)]="currentSales.sales_amount" name="sales_amount" step="0.01">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Total Received Amount:</label>
              <input type="number" [(ngModel)]="currentSales.received_amount" name="received_amount" step="0.01">
            </div>
            <div class="form-field">
              <label>Other Deductions:</label>
              <input type="number" [(ngModel)]="currentSales.other_deductions" name="other_deductions" step="0.01">
            </div>
            <div class="form-field">
              <label>Total Liters:</label>
              <input type="number" [(ngModel)]="currentSales.total_liters" name="total_liters" step="0.01">
            </div>
          </div>
          <div class="form-row">
            <button type="submit">{{currentSales.id ? 'Update' : 'Save'}} Route Sales</button>
            <button *ngIf="currentSales.id" type="button" class="btn-delete" (click)="deleteRouteSales()">Delete Sales</button>
          </div>
        </form>
        
        <!-- Display existing route sales -->
        <div *ngIf="getRouteSales().length > 0" class="existing-sales printable-sales">
          <h5>Existing Sales Records</h5>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Opening Balance</th>
                <th>Sales Amount</th>
                <th>Received Amount</th>
                <th>Deductions</th>
                <th>Net Balance</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let sale of getRouteSales()">
                <td>{{sale.date}}</td>
                <td>₹{{sale.opening_balance}}</td>
                <td>₹{{sale.sales_amount}}</td>
                <td>₹{{sale.received_amount}}</td>
                <td>₹{{sale.other_deductions}}</td>
                <td>₹{{sale.net_balance}}</td>
                <td>
                  <div class="action-buttons-horizontal">
                    <button class="btn-update btn-sm" (click)="editRouteSales(sale)">✏️ Edit</button>
                    <button class="btn-delete btn-sm" (click)="deleteRouteSalesById(sale.id)">🗑️ Delete</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Business Point Sales -->
      <div class="business-point-sales">
        <h4>Business Point Sales</h4>
        <div *ngFor="let bp of getRouteBusinessPoints()" class="bp-card">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h5>{{bp.name}}</h5>
            <div class="notification-buttons">
              <button class="btn-email btn-sm" (click)="sendEmail(bp)">📧 Email</button>
              <button class="btn-whatsapp btn-sm" (click)="sendWhatsApp(bp)">📱 WhatsApp</button>
            </div>
          </div>
          <form (ngSubmit)="saveBusinessPointSales(bp)" #bpSalesForm="ngForm">
            <div class="form-row">
              <div class="form-field">
                <label>Date:</label>
                <input type="date" [(ngModel)]="getBPSales(bp).date" name="date_{{bp.id}}" required>
              </div>
              <div class="form-field">
                <label>Opening Balance:</label>
                <input type="number" [(ngModel)]="getBPSales(bp).opening_balance" name="opening_{{bp.id}}" step="0.01">
              </div>
              <div class="form-field">
                <label>Sales Amount:</label>
                <input type="number" [(ngModel)]="getBPSales(bp).sales_amount" name="sales_{{bp.id}}" step="0.01">
              </div>
            </div>
            <div class="form-row">
              <div class="form-field">
                <label>Received Amount:</label>
                <input type="number" [(ngModel)]="getBPSales(bp).received_amount" name="received_{{bp.id}}" step="0.01">
              </div>
              <div class="form-field">
                <label>Deductions:</label>
                <input type="number" [(ngModel)]="getBPSales(bp).other_deductions" name="deductions_{{bp.id}}" step="0.01">
              </div>
              <div class="form-field">
                <label>Total Liters:</label>
                <input type="number" [(ngModel)]="getBPSales(bp).total_liters" name="liters_{{bp.id}}" step="0.01">
              </div>
            </div>
            <div class="form-row">
              <button type="submit">{{getBPSales(bp).id ? 'Update' : 'Save'}} {{bp.name}} Sales</button>
              <button *ngIf="getBPSales(bp).id" type="button" class="btn-delete" (click)="deleteBPSales(bp)">Delete Sales</button>
            </div>
          </form>
          
          <!-- Display existing BP sales -->
          <div *ngIf="getBPSalesList(bp).length > 0" class="existing-bp-sales">
            <h6>Previous Sales</h6>
            <table class="bp-sales-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Opening</th>
                  <th>Sales</th>
                  <th>Received</th>
                  <th>Net</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let sale of getBPSalesList(bp)">
                  <td>{{sale.date}}</td>
                  <td>₹{{sale.opening_balance}}</td>
                  <td>₹{{sale.sales_amount}}</td>
                  <td>₹{{sale.received_amount}}</td>
                  <td>₹{{sale.net_balance}}</td>
                  <td>
                    <div class="action-buttons-horizontal">
                      <button class="btn-update btn-sm" (click)="editBPSales(bp, sale)">✏️</button>
                      <button class="btn-delete btn-sm" (click)="deleteBPSalesById(sale.id)">🗑️</button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Supplier-wise Sales Summary -->
      <div class="supplier-sales">
        <h4>Supplier-wise Sales Summary</h4>
        <table>
          <thead>
            <tr>
              <th>Supplier</th>
              <th>Product</th>
              <th>Quantity</th>
              <th>Rate</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let rate of getRouteRates()">
              <td>{{rate.supplier_name}}</td>
              <td>{{rate.product_name}}</td>
              <td><input type="number" placeholder="Qty" step="0.01"></td>
              <td>₹{{rate.rate}}</td>
              <td>₹0.00</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Rates Tab -->
  <div *ngIf="activeTab === 'rates'" class="tab-content">
    <div class="section-header">
      <h2>Rates Management</h2>
      <div class="section-actions">
        <button class="print-btn" (click)="printRatesList()">🖨️ Print</button>
        <button class="export-btn" (click)="exportRatesData('csv')">📄 Export CSV</button>
        <button class="export-btn excel" (click)="exportRatesData('excel')">📈 Export Excel</button>
      </div>
    </div>
    
    <h3>Route Rates</h3>
    <form (ngSubmit)="saveRouteRate()" #rateForm="ngForm">
      <div class="form-row">
        <select [(ngModel)]="currentRate.route" name="route" required>
          <option value="">Select Route</option>
          <option *ngFor="let route of routes" [value]="route.id">{{route.name}}</option>
        </select>
        <select [(ngModel)]="currentRate.product" name="product" required>
          <option value="">Select Product</option>
          <option *ngFor="let product of products" [value]="product.id">{{product.supplier_name}} - {{product.name}}</option>
        </select>
        <input type="number" [(ngModel)]="currentRate.rate" name="rate" placeholder="Rate" step="0.01" required>
        <button type="submit">Save Route Rate</button>
      </div>
    </form>
    
    <table>
      <thead>
        <tr>
          <th>Route</th>
          <th>Supplier</th>
          <th>Product</th>
          <th>Rate</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let rate of routeRates">
          <td>{{rate.route_name}}</td>
          <td>{{rate.supplier_name}}</td>
          <td>{{rate.product_name}}</td>
          <td>₹{{rate.rate}}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-update btn-sm" (click)="editRouteRate(rate)">✏️ Update</button>
              <button class="btn-delete btn-sm" (click)="deleteRouteRate(rate.id)">🗑️ Delete</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <h3>Business Point Rates</h3>
    <form (ngSubmit)="saveBusinessPointRate()" #bpRateForm="ngForm">
      <div class="form-row">
        <select [(ngModel)]="currentBPRate.business_point" name="business_point" required>
          <option value="">Select Business Point</option>
          <option *ngFor="let bp of businessPoints" [value]="bp.id">{{bp.route_name}} - {{bp.name}}</option>
        </select>
        <select [(ngModel)]="currentBPRate.product" name="product" required>
          <option value="">Select Product</option>
          <option *ngFor="let product of products" [value]="product.id">{{product.supplier_name}} - {{product.name}}</option>
        </select>
        <input type="number" [(ngModel)]="currentBPRate.rate" name="rate" placeholder="Rate" step="0.01" required>
        <button type="submit">Save BP Rate</button>
      </div>
    </form>
    
    <table>
      <thead>
        <tr>
          <th>Business Point</th>
          <th>Supplier</th>
          <th>Product</th>
          <th>Rate</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let rate of businessPointRates">
          <td>{{rate.business_point_name}}</td>
          <td>{{rate.supplier_name}}</td>
          <td>{{rate.product_name}}</td>
          <td>₹{{rate.rate}}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-update btn-sm" (click)="editBusinessPointRate(rate)">✏️ Update</button>
              <button class="btn-delete btn-sm" (click)="deleteBusinessPointRate(rate.id)">🗑️ Delete</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>



  <!-- Bank Cash Flow Tab -->
  <div *ngIf="activeTab === 'bank-cashflow'" class="tab-content">
    <div class="section-header">
      <h2>Bank Cash Flow Management</h2>
      <div class="section-actions">
        <button class="print-btn" (click)="printBankCashFlowList()">🖨️ Print</button>
        <button class="export-btn" (click)="exportBankCashFlowData('csv')">📄 Export CSV</button>
        <button class="export-btn excel" (click)="exportBankCashFlowData('excel')">📈 Export Excel</button>
      </div>
    </div>
    
    <form (ngSubmit)="saveBankCashFlow()" #bankFlowForm="ngForm">
      <div class="form-row">
        <div class="form-field">
          <label>Date:</label>
          <input type="date" [(ngModel)]="currentBankFlow.date" name="date" required>
        </div>
        <div class="form-field">
          <label>Credit Amount:</label>
          <input type="number" [(ngModel)]="currentBankFlow.credit_amount" name="credit_amount" step="0.01" min="0">
        </div>
        <div class="form-field">
          <label>Debit Amount:</label>
          <input type="number" [(ngModel)]="currentBankFlow.debit_amount" name="debit_amount" step="0.01" min="0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field full-width">
          <label>Description:</label>
          <textarea [(ngModel)]="currentBankFlow.description" name="description" placeholder="Transaction description..."></textarea>
        </div>
      </div>
      <div class="form-row">
        <button type="submit">{{currentBankFlow.id ? 'Update' : 'Add'}} Bank Transaction</button>
        <button *ngIf="currentBankFlow.id" type="button" class="btn-delete" (click)="resetBankFlowForm()">Cancel Edit</button>
      </div>
    </form>
    
    <div class="bank-summary">
      <h4>Bank Cash Flow Summary</h4>
      <div class="summary-cards">
        <div class="summary-card credit">
          <label>Total Credit</label>
          <span>₹{{getTotalCredit()}}</span>
        </div>
        <div class="summary-card debit">
          <label>Total Debit</label>
          <span>₹{{getTotalDebit()}}</span>
        </div>
        <div class="summary-card balance">
          <label>Net Balance</label>
          <span [class]="getBankNetBalance() >= 0 ? 'positive-balance' : 'negative-balance'">₹{{getBankNetBalance()}}</span>
        </div>
      </div>
    </div>
    
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Credit Amount</th>
          <th>Debit Amount</th>
          <th>Net Amount</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let flow of bankCashFlows">
          <td>{{flow.date}}</td>
          <td class="credit-amount">₹{{flow.credit_amount}}</td>
          <td class="debit-amount">₹{{flow.debit_amount}}</td>
          <td [class]="(flow.net_amount || 0) >= 0 ? 'positive-balance' : 'negative-balance'">₹{{flow.net_amount || 0}}</td>
          <td>{{flow.description || 'N/A'}}</td>
          <td>
            <div class="action-buttons-horizontal">
              <button class="btn-update btn-sm" (click)="editBankCashFlow(flow)">✏️ Edit</button>
              <button class="btn-delete btn-sm" (click)="deleteBankCashFlow(flow.id)">🗑️ Delete</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Reports Tab -->
  <div *ngIf="activeTab === 'reports'" class="tab-content">
    <h2>Reports</h2>
    <div class="report-controls">
      <div class="date-range">
        <label>From Date:</label>
        <input type="date" [(ngModel)]="reportFromDate">
        <label>To Date:</label>
        <input type="date" [(ngModel)]="reportToDate">
      </div>
      <div class="filters">
        <select [(ngModel)]="selectedRouteId" (change)="onRouteChange()">
          <option value="">All Routes</option>
          <option *ngFor="let route of routes" [value]="route.id">{{route.name}}</option>
        </select>
        <select [(ngModel)]="selectedBusinessPointId" [disabled]="!selectedRouteId">
          <option value="">{{selectedRouteId ? 'All Business Points in Route' : 'Select Route First'}}</option>
          <option *ngFor="let bp of getFilteredBusinessPoints()" [value]="bp.id">{{bp.name}}</option>
        </select>
      </div>
    </div>
    
    <div class="report-buttons">
      <button (click)="generateCashBalanceReport()">Cash Balance Report</button>
      <button (click)="generateBusinessPointCashBalance()">Business Point Cash Balance</button>
      <button (click)="generateAgentCashFlowReport()">Agent Cash Flow</button>
      <button (click)="generateBankCashFlowReport()">Bank Cash Flow Report</button>
      <button (click)="generateCashClosingBalance()">Cash Closing Balance</button>
      <button (click)="generateProductionReport()">Production Report</button>
    </div>
    
    <div class="export-section">
      <h4>📊 Export Options</h4>
      <div class="export-controls">
        <div class="date-range-export">
          <label>Export Date Range:</label>
          <input type="date" [(ngModel)]="exportFromDate" placeholder="From Date">
          <input type="date" [(ngModel)]="exportToDate" placeholder="To Date">
        </div>
        <div class="export-buttons">
          <button class="export-btn" (click)="exportAllData('csv')">📄 Export All Data (CSV)</button>
          <button class="export-btn excel" (click)="exportAllData('excel')">📊 Export All Data (Excel)</button>
          <button class="export-btn" (click)="exportDateRangeData('csv')">📅 Export Date Range (CSV)</button>
          <button class="export-btn excel" (click)="exportDateRangeData('excel')">📅 Export Date Range (Excel)</button>
        </div>
      </div>
    </div>

    <div *ngIf="reportData" class="report-section">
      <div class="report-header">
        <h3>{{reportTitle}}</h3>
        <div class="report-actions">
          <button class="print-btn" (click)="printReport()">🖨️ Print</button>
          <button class="export-btn" (click)="exportReportCSV()">📄 Export CSV</button>
          <button class="export-btn excel" (click)="exportReportExcel()">📈 Export Excel</button>
        </div>
      </div>
      <div *ngIf="reportType === 'cash-balance'">
        <table>
          <thead>
            <tr>
              <th>Route</th>
              <th>Agent</th>
              <th>Opening Balance</th>
              <th>Sales Amount</th>
              <th>Total Amount</th>
              <th>Received Amount</th>
              <th>Net Balance</th>
              <th>Total Liters</th>
              <th>Notifications</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of reportData">
              <td>{{item.route}}</td>
              <td>{{item.agent}}</td>
              <td>₹{{item.opening_balance}}</td>
              <td>₹{{item.sales_amount}}</td>
              <td>₹{{item.total_amount}}</td>
              <td>₹{{item.received_amount}}</td>
              <td>₹{{item.net_balance}}</td>
              <td>{{item.total_liters}}L</td>
              <td>
                <div class="notification-buttons">
                  <button class="btn-email btn-sm" (click)="sendEmail({name: item.agent, route_name: item.route})">📧</button>
                  <button class="btn-whatsapp btn-sm" (click)="sendWhatsApp({name: item.agent, route_name: item.route})">📱</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="reportType === 'bp-cash-balance'">
        <table>
          <thead>
            <tr>
              <th>Business Point</th>
              <th>Route</th>
              <th>Opening Balance</th>
              <th>Sales Amount</th>
              <th>Total Amount</th>
              <th>Received Amount</th>
              <th>Net Balance</th>
              <th>Total Liters</th>
              <th>Notifications</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of reportData">
              <td>{{item.business_point}}</td>
              <td>{{item.route}}</td>
              <td>₹{{item.opening_balance}}</td>
              <td>₹{{item.sales_amount}}</td>
              <td>₹{{item.total_amount}}</td>
              <td>₹{{item.received_amount}}</td>
              <td>₹{{item.net_balance}}</td>
              <td>{{item.total_liters}}L</td>
              <td>
                <div class="notification-buttons">
                  <button class="btn-email btn-sm" (click)="sendEmail({name: item.business_point, route_name: item.route})">📧</button>
                  <button class="btn-whatsapp btn-sm" (click)="sendWhatsApp({name: item.business_point, route_name: item.route})">📱</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="reportType === 'bp-cash-flow'" class="closing-balance">
        <div class="balance-item">
          <label>Business Point:</label>
          <span>{{reportData.business_point}}</span>
        </div>
        <div class="balance-item">
          <label>Route:</label>
          <span>{{reportData.route}}</span>
        </div>
        <div class="balance-item">
          <label>Inward Amount:</label>
          <span>₹{{reportData.inward_amount}}</span>
        </div>
        <div class="balance-item">
          <label>Outward Amount:</label>
          <span>₹{{reportData.outward_amount}}</span>
        </div>
        <div class="balance-item total">
          <label>Closing Balance:</label>
          <span>₹{{reportData.closing_balance}}</span>
        </div>
      </div>

      <div *ngIf="reportType === 'closing-balance'" class="closing-balance">
        <div class="balance-item">
          <label>Agent Cash Flow Total:</label>
          <span>₹{{reportData.agent_cash_flow_total}}</span>
        </div>
        <div class="balance-item">
          <label>Bank Cash Flow Total:</label>
          <span>₹{{reportData.bank_cash_flow_total}}</span>
        </div>
        <div class="balance-item total">
          <label>Total Closing Balance:</label>
          <span>₹{{reportData.total_closing_balance}}</span>
        </div>
      </div>

      <div *ngIf="reportType === 'production'">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Route</th>
              <th>Supplier</th>
              <th>Product</th>
              <th>Produced</th>
              <th>Distributed</th>
              <th>Remaining</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of reportData">
              <td>{{item.date}}</td>
              <td>{{item.route}}</td>
              <td>{{item.supplier}}</td>
              <td>{{item.product}}</td>
              <td>{{item.crates_produced}} crates</td>
              <td>{{item.crates_distributed}} crates</td>
              <td>{{item.crates_remaining}} crates</td>
              <td>{{item.notes || 'N/A'}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Settings Tab -->
  <div *ngIf="activeTab === 'settings'" class="tab-content">
    <h2>Email Configuration</h2>
    <form (ngSubmit)="saveEmailSettings()" #settingsForm="ngForm">
      <div class="form-row">
        <div class="form-field">
          <label>From Email:</label>
          <input type="email" [(ngModel)]="emailSettings.from_email" name="from_email" placeholder="your-email@gmail.com" required>
        </div>
        <div class="form-field">
          <label>Email Password:</label>
          <input type="password" [(ngModel)]="emailSettings.from_password" name="from_password" placeholder="App Password" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>SMTP Server:</label>
          <input type="text" [(ngModel)]="emailSettings.smtp_server" name="smtp_server" value="smtp.gmail.com" readonly>
        </div>
        <div class="form-field">
          <label>SMTP Port:</label>
          <input type="number" [(ngModel)]="emailSettings.smtp_port" name="smtp_port" value="587" readonly>
        </div>
      </div>
      <div class="form-row">
        <button type="submit">💾 Save Email Settings</button>
      </div>
    </form>
    
    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
      <h4>📝 Setup Instructions:</h4>
      <ol>
        <li>Use Gmail account for sending emails</li>
        <li>Enable 2-Factor Authentication in Gmail</li>
        <li>Generate App Password: Google Account → Security → App passwords</li>
        <li>Use the App Password (not your regular password)</li>
        <li>Enter your Gmail and App Password above</li>
      </ol>
    </div>
  </div>

  <!-- Agent Overview Tab -->
  <div *ngIf="activeTab === 'agent-overview'" class="tab-content">
    <h2>Agent Overview by Route</h2>
    
    <!-- Route Selection -->
    <div class="route-buttons">
      <h3>Select Route:</h3>
      <button *ngFor="let route of routes" 
              (click)="selectRouteForOverview(route)" 
              [class.active]="selectedOverviewRoute?.id === route.id">
        {{route.name}}
      </button>
    </div>

    <div *ngIf="selectedOverviewRoute" class="agent-overview-section">
      <h3>{{selectedOverviewRoute.name}} Route - Agent Details</h3>
      
      <table>
        <thead>
          <tr>
            <th>Agent Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Total Debt</th>
            <th>Today's Received</th>
            <th>Net Balance</th>
            <th>Last Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let agent of getRouteAgentOverview(); let i = index">
            <td>
              <input *ngIf="agent.editing" type="text" [(ngModel)]="agent.name" class="edit-input" (blur)="saveAgentEdit(agent)" (keyup.enter)="saveAgentEdit(agent)">
              <strong *ngIf="!agent.editing" (click)="startEdit(agent)">{{agent.name}} ✏️</strong>
            </td>
            <td>
              <input *ngIf="agent.editing" type="email" [(ngModel)]="agent.email" class="edit-input" placeholder="Email">
              <span *ngIf="!agent.editing" (click)="startEdit(agent)">{{agent.email || 'Click to add'}} ✏️</span>
            </td>
            <td>
              <input *ngIf="agent.editing" type="tel" [(ngModel)]="agent.phone" class="edit-input" placeholder="Phone">
              <span *ngIf="!agent.editing" (click)="startEdit(agent)">{{agent.phone || 'Click to add'}} ✏️</span>
            </td>
            <td class="debt-amount">₹{{agent.total_debt}}</td>
            <td class="received-amount">₹{{agent.todays_received}}</td>
            <td [class]="agent.net_balance >= 0 ? 'positive-balance' : 'negative-balance'">
              ₹{{agent.net_balance}}
            </td>
            <td>{{agent.last_updated}}</td>
            <td>
              <div *ngIf="agent.editing" class="edit-actions">
                <button class="btn-update btn-sm" (click)="saveAgentEdit(agent)">✓ Save</button>
                <button class="btn-delete btn-sm" (click)="cancelEdit(agent)">✗ Cancel</button>
              </div>
              <div *ngIf="!agent.editing" class="notification-buttons">
                <button class="btn-email btn-sm" (click)="sendDebtReminder(agent)">📧 Debt</button>
                <button class="btn-whatsapp btn-sm" (click)="sendPaymentReminder(agent)">📱 Pay</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      
      <div class="route-summary">
        <h4>Route Summary</h4>
        <div class="summary-cards">
          <div class="summary-card debt">
            <label>Total Route Debt:</label>
            <span>₹{{getRouteTotalDebt()}}</span>
          </div>
          <div class="summary-card received">
            <label>Today's Total Received:</label>
            <span>₹{{getRouteTotalReceived()}}</span>
          </div>
          <div class="summary-card balance">
            <label>Route Net Balance:</label>
            <span>₹{{getRouteNetBalance()}}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Route Dashboard Tab -->
  <div *ngIf="activeTab === 'route-dashboard'" class="tab-content">
    <h2>Route Performance Dashboard</h2>
    
    <div class="route-dashboard">
      <div *ngFor="let route of getRouteSummaries()" class="route-card">
        <div class="route-header">
          <h4>{{route.name}} Route</h4>
          <span class="agent-count">{{route.agent_count}} Agents</span>
        </div>
        
        <div class="route-metrics">
          <div class="metric">
            <label>Total Business</label>
            <span class="business-amount">₹{{route.total_business}}</span>
          </div>
          <div class="metric">
            <label>Outstanding</label>
            <span class="debt-amount">₹{{route.total_debt}}</span>
          </div>
          <div class="metric">
            <label>Today's Collection</label>
            <span class="received-amount">₹{{route.todays_received}}</span>
          </div>
          <div class="metric">
            <label>Net Balance</label>
            <span [class]="route.net_balance >= 0 ? 'positive-balance' : 'negative-balance'">₹{{route.net_balance}}</span>
          </div>
        </div>
        
        <div class="route-progress">
          <label>Collection Rate: {{route.collection_rate}}%</label>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="route.collection_rate"></div>
          </div>
        </div>
        
        <div class="route-agents">
          <h5>Top Performers</h5>
          <div class="agent-list">
            <div *ngFor="let agent of route.top_agents" class="agent-item">
              <span class="agent-name">{{agent.name}}</span>
              <span [class]="agent.balance >= 0 ? 'positive-balance' : 'negative-balance'">₹{{agent.balance}}</span>
            </div>
          </div>
        </div>
        
        <div class="route-actions">
          <button class="btn-update btn-sm" (click)="viewRouteDetails(route)">🔍 View Details</button>
          <button class="btn-email btn-sm" (click)="sendRouteSummary(route)">📧 Email Summary</button>
        </div>
      </div>
    </div>
  </div>
</div>